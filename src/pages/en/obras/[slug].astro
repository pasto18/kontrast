---
// src/pages/obras/[slug].astro (o la ruta donde lo tengas)
import Layout from '../../../layouts/layout.astro';
import { getEntry } from 'astro:content';
import { marked } from 'marked';

// 1. Detectamos el idioma actual
const lang = Astro.currentLocale || 'ca';

const { slug } = Astro.params;
if (!slug) return Astro.redirect('/404');

const obra = await getEntry('obras', slug);
if (!obra) return Astro.redirect('/404');

const data = obra.data;

// --- FUNCIONES DE AYUDA ---
function renderMarkdown(text) {
    if (!text) return '';
    return marked.parse(text);
}

function getYouTubeID(url) {
    if (!url) return null;
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
}

// Traducciones locales para esta página
const t = {
    comprar: lang === 'en' ? 'BUY TICKETS' : 'COMPRAR ENTRADES',
    categoria: (data.categoria === 'Otro' && data.categoria_manual) ? data.categoria_manual : data.categoria
};

const videoID = getYouTubeID(data.video);
const tipoShow = t.categoria || 'CIRC';

function formatearFecha(fechaStr) {
    if (!fechaStr) return "";
    const fecha = new Date(fechaStr);
    // Usamos el idioma actual para el nombre del día
    const locale = lang === 'en' ? 'en-GB' : 'ca-ES';
    const diaSemana = fecha.toLocaleDateString(locale, { weekday: 'long' });
    const dia = fecha.getDate().toString().padStart(2, '0');
    const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
    return `${diaSemana} ${dia}/${mes}`.toUpperCase();
}
---

<Layout title={data.titulo}>
    
    {videoID && (
        <div id="video-wrapper">
            <div id="video-dimmer"></div>
            <div id="youtube-player" data-id={videoID}></div>
        </div>
    )}

    <div class="contenedor-principal contenido-flotante" style="padding: 0 2% ;">
        <header>
            <h1 class="obra-titulo">{data.titulo}</h1>
            <div style="display: flex; flex:row; height: fit-content; align-items:center; gap: 15px; margin-top: 7vh;">
                <p class="obra-compania">
                    <a href={data.web_compania || '#'} target="_blank">{data.compania}</a>
                </p>
                {tipoShow && <span class="etiqueta-tipo gigante">{tipoShow}</span>}
            </div>
        </header>

        <div class="col-der">
            <div class="caja-tickets">
                <ul style="padding: 0; margin-bottom: 0px;">
                    {data.pases.map(pase => (
                        <li class="pase-item">
                           {formatearFecha(pase.fecha)} - {pase.hora}
                        </li>
                    ))}
                </ul>
                {data.entradas_url && (
                    <a href={data.entradas_url} target="_blank" class="btn-entrades-2">{t.comprar}</a>
                )}
            </div>
        </div> 

        <div class="espacio-video"></div>

        <div class="col-izq bg-blanco">
            <div class="obra-sinopsis">
                {lang === 'en' ? (
                    data.sinopsis_eng && <div class="lang-section" set:html={renderMarkdown(data.sinopsis_eng)} />
                ) : (
                    data.sinopsis_cat && <div class="lang-section" set:html={renderMarkdown(data.sinopsis_cat)} />
                )}
            </div>

            <div class="galeria-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 30px;">
                {data.fotos && data.fotos.map(foto => (
                    <img src={foto} alt={`Foto de ${data.titulo}`} class="galeria-img" style="width: 100%; border-radius: 8px;"/>
                ))}
            </div>
        </div>
    </div>
    <div style="height: 50px;"></div>
</Layout>

<style>
    /* ... Tus estilos CSS se mantienen exactamente igual ... */
    #video-wrapper { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0; overflow: hidden; }
    :global(iframe#youtube-player) { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100vw; height: 56.25vw; min-height: 100vh; min-width: 177.77vh; max-width: none !important; pointer-events: none; }
    #video-dimmer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 2; cursor: pointer; transition: background-color 1s ease; display: flex; align-items: center; justify-content: center; }
    .contenedor-principal { position: relative; z-index: 10; max-width: 100vw; padding: 0 6%; pointer-events: none; }
    .espacio-video { height: 55vh; width: 100%; }
    header, .col-der, .col-izq, .btn-volver { pointer-events: auto; }
    .bg-blanco { background-color: rgba(0, 0, 0, 0.85); padding: 40px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-top: 20px; color: var(--c-blanco); }
    .obra-titulo { text-shadow: 0 5px 15px rgba(0,0,0,0.5); color:var(--c-blanco); mix-blend-mode: difference; }
    .lang-section :global(p) { margin-bottom: 1rem; line-height: 1.6; }
    .lang-section :global(h1), .lang-section :global(h2) { margin-top: 1.5rem; margin-bottom: 0.5rem; }
</style>

<!-- SCRIPT YOUTUBE -->
<script>
    var player;
    const wrapper = document.getElementById('video-wrapper');
    const dimmer = document.getElementById('video-dimmer');
    const playerDiv = document.getElementById('youtube-player');
    const videoId = playerDiv ? playerDiv.getAttribute('data-id') : null;

    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    window.onYouTubeIframeAPIReady = function() {
        if (!videoId) return;
        player = new YT.Player('youtube-player', {
            videoId: videoId,
            playerVars: { 'autoplay': 1, 'controls': 0, 'disablekb': 1, 'fs': 0, 'mute': 1, 'loop': 1, 'playlist': videoId, 'playsinline': 1, 'rel': 0, 'showinfo': 0, 'modestbranding': 1 },
            events: { 'onReady': onPlayerReady }
        });
    };

    function onPlayerReady(event) {
        event.target.playVideo();
        if (dimmer) dimmer.addEventListener('click', toggleSonido);
    }

    function toggleSonido() {
        const estaActivo = wrapper.classList.contains('video-activo');
        if (estaActivo) {
            wrapper.classList.remove('video-activo');
            if(player) player.mute();
        } else {
            wrapper.classList.add('video-activo');
            if(player) {
                player.unMute();
                player.setVolume(100);
            }
        }
    }
</script>