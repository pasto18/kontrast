---
import Layout from '../layouts/layout.astro';
import { getCollection } from 'astro:content';

// 1. Obtenemos las obras de la colección
const obras = await getCollection('obras');

// 2. Ordenamos por fecha
const obrasOrdenadas = obras.sort((a, b) => {
    const fechaA = new Date(a.data.pases[0].fecha);
    const fechaB = new Date(b.data.pases[0].fecha);
    return fechaA - fechaB;
});

// 3. Función para formatear fechas (NO OLVIDAR ESTO)
function formatearFecha(fechaStr) {
    if (!fechaStr) return "";
    const fecha = new Date(fechaStr);
    const diaSemana = fecha.toLocaleDateString('ca-ES', { weekday: 'long' });
    const dia = fecha.getDate().toString().padStart(2, '0');
    const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
    return `${diaSemana} ${dia}/${mes}`.toUpperCase();
}
---

<Layout title="Programación">
    
    <div class="contenedor-principal">
        <h1 class="titulo-festival">Programació 2026<br><small style="font-size: 1rem; font-weight: normal; color: #666;">DESCARREGA TOTA LA PROGRAMACIÓ</small></h1>
        
        <main class="cartelera-grid">
            {obrasOrdenadas.map((obra) => {
                
                /* --- ZONA DE LÓGICA (Dentro de las llaves) --- */
                
                // Calculamos qué texto mostrar
                const tipoShow = (obra.data.categoria === 'Otro' && obra.data.categoria_manual) 
                    ? obra.data.categoria_manual 
                    : obra.data.categoria;

                /* --- ZONA DE HTML (El return explícito) --- */
                return (
                    <a href={`/obras/${obra.slug}`} class="card-link">
                        <article class="card-obra">
                            <div class="card-img-container">
                                <img src={obra.data.fotos[0]} alt={obra.data.titulo} class="card-img"/>
                            </div>
                            
                            <div class="card-content">
                                 
                                 <div style="display:flex;flex-direction:row;justify-content:space-between;align-items:center;width:100%; margin-bottom: auto">
                                 <!-- 1. ETIQUETA -->
                {tipoShow && <span class="etiqueta-tipo">{tipoShow}</span>}
    
    <!-- 2. FECHA -->
    <span class="card-fecha">
       {formatearFecha(obra.data.pases[0].fecha)}
    </span>
    </div>
    
    <!-- 3. TÍTULO -->
    <h2 class="card-titulo">{obra.data.titulo}</h2>
    
    <!-- 4. COMPAÑÍA -->
    <p class="card-compania">{obra.data.compania}</p>

   <!-- 5 . BOTÓN (Ahora es hermano de los demás) -->
    <!-- <span class="btn-entradas">+ INFO</span>-->
                            </div>
                        </article>
                    </a>
                );
            })}
        </main>
    </div>

</Layout>