---
import Layout from '../layouts/layout.astro';

// Generamos una lista falsa de compañías para no repetir código
const listaCompanias = [
    "Compañía de Circo 'eia'", "Sacékripa", "My!Laika", "JÁNIKA company", 
    "Francine Satu", "Esteros live project", "Lupa Maimone/Oltrenotte", 
    "Cie. Kimera", "Sofia de la Zambra", "Cirque Pardi!", "Collectif Les Idoles",
    "Blanco Teta", "Brik Tu-Tok", "Ivana Ray Singh", "Kimchi", "Wes Peden",
    "Las Corpa & Humo y Polvo", "Cru Lab", "Cia. La Víspera", "NourKara.ir",
    "EBC - 223", "Trobada Cirqueras i Discidències", "Intrepidus Squad",
    "Copia - Coconauta", "Frà9il", "CORTEXXX (VJ)", "Cie. Circoncentrique",
    "Fernanda Alemán", "Cabezadenego", "Gin Bali", "Fiesta en el vacío",
    "Alta Gama", "Société protectrice de petites idées", "Kabaret Kontrast"
];

const ediciones = [
    { 
        year: "2025", titulo: "#5", color: "#FF3B30", 
        cartel: "/img/k-5-cartel.jpg", video: "https://www.youtube.com/embed/dQw4w9WgXcQ",
        extras: ["/img/k5-1.jpg", "/img/k5-2.jpg"],
        companys: listaCompanias // Asignamos la lista
    },
    { 
        year: "2024", titulo: "#4", color: "#FFCC00", 
        cartel: "/img/k-4-cartel.jpg", video: "https://www.youtube.com/embed/dQw4w9WgXcQ",
        extras: ["/img/obras/foto2.jpg"],
        companys: listaCompanias
    },
    { 
        year: "2023", titulo: "#3", color: "#007AFF", 
        cartel: "/img/k-3-cartel.jpg", video: "https://www.youtube.com/embed/dQw4w9WgXcQ",
        extras: ["/img/obras/foto2.jpg"],
        companys: listaCompanias
    },
    { 
        year: "2022", titulo: "#2", color: "#FF9500", 
        cartel: "/img/k-2-cartel.jpg", video: "https://www.youtube.com/embed/dQw4w9WgXcQ",
        extras: ["/img/obras/foto2.jpg"],
        companys: listaCompanias
    },
    { 
        year: "2021", titulo: "#1", color: "#FF9500", 
        cartel: "/img/obras/foto1.jpg", video: "https://www.youtube.com/embed/dQw4w9WgXcQ",
        extras: ["/img/obras/foto2.jpg"],
        companys: listaCompanias
    },
];

---

<Layout title="Histórico">
    
    <div class="main-wrapper">
        <div class="horizontal-container">
            
            <!-- PANEL 1: INTRO -->
            <section class="panel intro">
                <h1 class="parallax-fast">HISTÒRIA<br>DEL<br>FESTIVAL</h1>
                <p>Scroll ↓</p>
            </section>

            <!-- PANELES DE EDICIONES -->
            {ediciones.map((ed, i) => (
                <section class="panel edicion">
                    
                    <!-- CAPA 0: AÑO -->
                    <div class="bg-year parallax-slow" style={`color: ${ed.color}15`}>
                        {ed.year}
                    </div>

                    <!-- CAPA 1: FOTOS EXTRA -->
                    {ed.extras.map((img, idx) => (
                        <div class={`scattered-img scattered-${idx + 1} parallax-scattered`}>
                            <img src={img} alt="Foto extra" />
                        </div>
                    ))}

                    <!-- CAPA 2: CONTENIDO MEDIA (Cartel y Video) -->
                    <!-- Antes esto envolvía al título, ahora NO -->
                    <div class="content-box">
                        <div class="media-grid">
                            <div class="img-box parallax-mid">
                                <img src={ed.cartel} alt="Cartel" />
                            </div>
                            <div class="video-box parallax-mid-reverse">
                                <iframe src={ed.video} frameborder="0"></iframe>
                            </div>
                        </div>
                    </div>

                    <!-- CAPA 3: LISTA COMPAÑÍAS -->
                    <div class="companies-block parallax-companies">
                        <h3 style={`color: ${ed.color}`}>LINE UP {ed.year}</h3>
                        <p>
                            <!-- Esta es la parte que faltaba: El bucle que escribe los nombres -->
                            {ed.companys && ed.companys.map((c, index) => (
                                <>
                                    <span>{c}</span>
                                    {/* Añadimos el puntito separador si no es el último */}
                                    {index < ed.companys.length - 1 && <span class="separator"> • </span>}
                                </>
                            ))}
                        </p>
                    </div>
                    <!-- CAPA 4: TÍTULO GIGANTE (AHORA ES INDEPENDIENTE) -->
                    <!-- Al ponerlo al final del HTML, naturalmente se pinta encima -->
                    <div class="titulo-wrapper parallax-fast">
                         <h2 style={`color: ${ed.color}; -webkit-text-stroke: 2px ${ed.color}; color: transparent;`}>
                            {ed.titulo}
                         </h2>
                    </div>

                </section>
            ))}

            <!-- PANEL FINAL -->
            <section class="panel final">
                <h2>CONTINUARÀ...</h2>
            </section>

        </div>
    </div>

    <div class="normal-content">
        <p>Vuelve al inicio para ver más.</p>
    </div>

</Layout>

<style>
    /* ESTRUCTURA BASE */
    .main-wrapper {
        width: 100%;
        height: 100vh;
        overflow: hidden;
    }

    .horizontal-container {
        display: flex;
        flex-wrap: nowrap;
        height: 100%;
        width: 500%; 
    }

    .panel {
        width: 200vw; 
        height: 100vh;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        background: #050505;
        color: white;
        overflow: hidden; 
    }

    /* INTRO */
    .intro h1 { font-size: 6rem; line-height: 0.9; font-weight: 900; letter-spacing: -2px; }

    /* AÑO VERTICAL (A LA IZQUIERDA) */
    .bg-year {
        position: absolute;
        font-size: 20vw;
        font-weight: 900;
        z-index: 0;
        top: 50%; 
        left: -8%; 
        transform: translateY(-50%) rotate(-90deg);
        pointer-events: none;
        white-space: nowrap;
        /* mix-blend-mode: overlay; Eliminado para asegurar visibilidad */
    }

    /* Ajustamos el contenedor de las fotos para que no moleste */
    .content-box { 
        z-index: 10; 
        text-align: center; 
        position: relative;
        width: 80vw;
        left: -25vw; /* Ajuste visual opcional */
    }

    /* EL TÍTULO FLOTANTE SUPREMO */
    .titulo-wrapper {
        position: absolute; /* Ahora flota libre */
        top: 50%;           /* Centrado vertical */
        left: 0;
        width: 100%;
        transform: translateY(-50%); /* Centrado perfecto */
        
        z-index: 9999 !important; /* Ahora sí funciona porque no tiene padres que lo limiten */
        pointer-events: none;     /* Deja pasar clicks */
        
        display: flex;
        justify-content: center;  /* Centrado horizontal */
        align-items: center;
    }

    .titulo-wrapper h2 { 
        font-size: 15rem; 
        margin: 0; /* Quitamos márgenes viejos */
        line-height: 1;
        letter-spacing: -8px;
        white-space: nowrap;
        
        /* El margen negativo para moverlo a la izquierda lo mantenemos aquí */
        margin-left: -140vw; 
    }

    /* GRID PRINCIPAL */
    .media-grid { 
        display: flex; 
        gap: 50px; 
        align-items: center; 
        justify-content: center;
        position: relative;
        z-index: 10;
    }

    .img-box { 
        width: 65vw; height: 42vw; 
        background: #333; 
        box-shadow: 0 30px 60px rgba(0,0,0,0.8);
    }
    .img-box img { width: 100%; height: 100%; object-fit: cover; }
    
    .video-box { 
        width: 80vw; height: 44.5vw; 
        background: #000;
        border: 2px solid #333;
        box-shadow: 0 30px 60px rgba(0,0,0,0.8);
    }
    .video-box iframe { width: 100%; height: 100%; }

   /* --- FOTOS EXTRA --- */
   .scattered-img img { 
        width: 100%;      /* Ocupa el ancho que le diste al div */
        height: auto;     /* Calcula el alto natural */
        display: block;   /* Evita espacios blancos debajo */
        object-fit: contain; /* Asegura que se vea entera */
    }
    .scattered-img:hover { 
        filter: grayscale(0%); 
        /* z-index: 50;  <--- ¡BORRA ESTA LÍNEA! Así no se suben encima al pasar el ratón */
    }

    /* La imagen interna es la que crecerá */
    .scattered-img img, .img-box img {
        width: 100%; 
        height: 100%; 
        object-fit: cover;
        transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); /* Zoom suave */
    }

    /* --- CLASE ACTIVA (CLICK) --- */
    /* Cuando el contenedor tiene la clase .is-expanded... */
    
    /* 1. Subimos el Z-index del contenedor para que tape a los vecinos */
    .scattered-img.is-expanded, .img-box.is-expanded {
        z-index: 5000 !important; /* Alto, pero menor que el título (9999) */
        filter: grayscale(0%);
        cursor: zoom-out;
    }

    /* 2. Escalamos la IMAGEN de dentro (no el div) */
    .scattered-img.is-expanded img, .img-box.is-expanded img {
        transform: scale(1.5); /* <--- AQUÍ ESTÁ EL ZOOM */
        box-shadow: 0 50px 100px rgba(0,0,0,0.5); /* Sombra para resaltar */
    }

    .scattered-1 { 
        top: 15%; 
        left: 65%; 
        width: 75vw; 
        height: auto; /* <--- CAMBIO: Se ajusta solo */
        z-index: 5; 
    }
    
    .scattered-2 { 
        bottom: 0%; 
        left: 30%; 
        width: 30vw; 
        height: auto; /* <--- CAMBIO */
        z-index: 1; 
        opacity: 1; 
    }
    
    .scattered-3 { 
        top: 10%; 
        right: 15%; 
        width: 20vw; 
        height: auto; /* <--- CAMBIO */
        z-index: 8; 
    }
    /* --- BLOQUE DE COMPAÑÍAS (Corregido) --- */
    .companies-block {
        position: absolute;
        top: 25%;        /* Un poco más abajo para dar aire */
        right: 15vw;     /* Lo alejamos del borde derecho para que no toque la siguiente edición */
        
        /* DIMENSIONES DEL BLOQUE */
        width: 35vw;     /* Un ancho considerable */
        max-width: 600px; /* Pero que no se pase de grande en pantallas gigantes */
        
        text-align: left;
        z-index: 5;      /* Delante del fondo, detrás del título gigante */
        color: #ddd;
        
        /* Estilo de "Caja" */
        display: flex;
        flex-direction: column;
        align-items: flex-start; /* Alineado a la izquierda */
    }

    .companies-block h3 {
        font-size: 1rem;
        font-weight: 900;
        text-transform: uppercase;
        margin-bottom: 15px;
        letter-spacing: 2px;
        border-bottom: 2px solid currentColor;
        padding-bottom: 5px;
        display: inline-block;
    }

    .companies-block p {
        font-size: 1.5rem;       /* Tamaño legible */
        line-height: 1.5;      /* Buen interlineado */
        font-weight: 400;
        
        /* ESTO HACE LA MAGIA DEL BLOQUE */
        text-align: justify;   /* Texto justificado como un bloque sólido */
        width: 100%;           /* Ocupa todo el ancho del padre */
    }
    
    .companies-block span {
        /* CAMBIO CLAVE: */
        white-space: normal;   /* Permite que el texto salte de línea */
        display: inline;       /* Se comportan como texto seguido */
    }

    /* Ajuste para que los separadores se vean bien */
    .separator {
        color: inherit;
        opacity: 0.5;
        margin: 0 5px;
    }

    .normal-content { height: 50vh; background: white; color: black; display: flex; align-items: center; justify-content: center; }

    /* MÓVIL */
    @media (max-width: 768px) {
        .titulo-wrapper h2 { font-size: 4rem; margin-bottom: 20px; }
        .media-grid { flex-direction: column; }
        .img-box { width: 80vw; height: 100vw; }
        .video-box { width: 90vw; height: 50vw; }
        .bg-year { font-size: 40vw; transform: translate(-50%, -50%); top: 50%; left: 50%; rotate: 0deg; opacity: 0.2; }
        .scattered-img { display: none; }
        .companies-block { position: relative; width: 90%; right: auto; top: auto; margin: 40px auto; text-align: center; }
        .companies-block p { text-align: center; font-size: 0.8rem; }
    }
</style>

<script>
    import { gsap } from "gsap";
    import { ScrollTrigger } from "gsap/ScrollTrigger";

    gsap.registerPlugin(ScrollTrigger);

    const container = document.querySelector(".horizontal-container");
    // @ts-ignore
    const panels = gsap.utils.toArray(".panel");

    // 1. EL TREN PRINCIPAL
    const scrollTween = gsap.to(panels, {
        xPercent: -100 * (panels.length - 1),
        ease: "none",
        scrollTrigger: {
            trigger: ".main-wrapper",
            pin: true,
            scrub: 1,
            end: "+=4000", 
        }
    });

    // 2. EFECTOS PARALLAX
    panels.forEach((panel) => {
        // @ts-ignore
        const q = gsap.utils.selector(panel);

        // A. TEXTO RÁPIDO
        gsap.to(q(".parallax-fast"), {
            x: -900, 
            ease: "none",
            scrollTrigger: {
                trigger: panel,
                containerAnimation: scrollTween, 
                start: "left right", 
                end: "right left",   
                scrub: true,
            }
        });

        // B. FONDO AÑO (Izquierda) - Leve movimiento para no despegarse
        gsap.to(q(".parallax-slow"), {
            x: 50, // Se mueve muy poquito para mantenerse anclado visualmente
            ease: "none",
            scrollTrigger: {
                trigger: panel,
                containerAnimation: scrollTween,
                start: "left right",
                end: "right left",
                scrub: true,
            }
        });

        // C. CARTEL PRINCIPAL
        gsap.fromTo(q(".parallax-mid"), 
            { 
                // AQUÍ DEFINIMOS EL INICIO (Lo que intentabas en CSS)
                xPercent: -100,  // Equivale a tu translate X -30%
                yPercent: 12,   // Equivale a tu translate Y 150% (Empieza muy abajo)
            }, 
            { 
                // AQUÍ DEFINIMOS EL FINAL (A dónde llega al scrollear)
                xPercent: -450,  // Mantenemos la X igual para que no se mueva lateralmente
                yPercent: 12,    // Sube hasta su posición natural (0%)
                
                ease: "none",
                scrollTrigger: {
                    trigger: panel,
                    containerAnimation: scrollTween,
                    start: "left right",
                    end: "right left",
                    scrub: true,
                }
            }
        );
        
        // D. VIDEO
        gsap.fromTo(q(".parallax-mid-reverse"), { x: 100, y: -150 }, { x: -100, y: 150, ease: "none",
            scrollTrigger: { trigger: panel, containerAnimation: scrollTween, start: "left right", end: "right left", scrub: true }
        });

        // E. FOTOS EXTRA
        const scattered = q(".parallax-scattered");
        if(scattered.length > 0) {
            gsap.fromTo(scattered, 
                { 
                    // INICIO (Desde la derecha)
                    x: (i) => {
                        // Si es la FOTO 2 (índice 1), empieza más cerca (ej: 600px)
                        // Cuanto más bajo sea este número, ANTES aparece.
                        if (i === 1) return 1300; 
                        
                        // El resto (Fotos 1 y 3) siguen la fórmula normal (lejos)
                        return (i + 1) * 1200;
                    },
                    // Borramos la 'y' de aquí para que no salte al empezar
                }, 
                { 
                    // FINAL (Hacia la izquierda)
                    x: (i) => (i + 5) * -200, 
                    
                    y: 0, // Forzamos a que NO haya movimiento vertical
                    
                    ease: "none",
                    scrollTrigger: {
                        trigger: panel,
                        containerAnimation: scrollTween,
                        start: "left right",
                        end: "right left",
                        scrub: true,
                    }
                }
            );
        }

        // F. LISTA DE COMPAÑÍAS (NUEVO)
        // Se mueve un poco más lento que el tren para que parezca que "entra tarde"
        gsap.fromTo(q(".parallax-companies"), 
            { x: 100, opacity: 0 }, 
            { 
                x: -250, opacity: 1, // Entra y se acomoda
                ease: "none",
                scrollTrigger: {
                    trigger: panel,
                    containerAnimation: scrollTween,
                    start: "left center", // Empieza cuando el panel está centrado
                    end: "right left",
                    scrub: true,
                }
            }
        );
    });

    // --- LÓGICA DE ZOOM AL HACER CLIC ---
    
    // Seleccionamos todas las cajas de imágenes (las extra y las principales)
    const allImages = document.querySelectorAll('.scattered-img, .img-box');

    allImages.forEach(box => {
        box.addEventListener('click', (e) => {
            // Evitamos que el clic llegue al fondo y cierre inmediatamente
            e.stopPropagation();

            // Comprobamos si ya está abierta
            const isActive = box.classList.contains('is-expanded');

            // 1. Cerramos TODAS las imágenes primero (para que solo haya una abierta)
            allImages.forEach(el => el.classList.remove('is-expanded'));

            // 2. Si la que clickeé no estaba abierta, la abro
            if (!isActive) {
                box.classList.add('is-expanded');
            }
        });
    });

    // Opcional: Clic en cualquier otro sitio para cerrar el zoom
    window.addEventListener('click', () => {
        allImages.forEach(el => el.classList.remove('is-expanded'));
    });
</script>