---
// src/components/sections/programacion.astro
import { getCollection } from 'astro:content';

const obras = await getCollection('obras');

// 1. Detectamos el idioma actual
const lang = Astro.currentLocale || 'ca';

// 2. Definimos la base de la URL para las obras
const baseRoute = lang === 'en' ? '/en/obras/' : '/obras/';

// 3. Traducciones para los textos de esta sección
const t = {
    titulo_seccion: lang === 'en' ? 'PROGRAM' : 'PROGRAMACIÓ'
};

function formatearFecha(fechaStr) {
    if (!fechaStr) return "";
    const fecha = new Date(fechaStr);
    
    // Usamos el idioma actual para el formato de fecha
    const locale = lang === 'en' ? 'en-GB' : 'ca-ES';
    const diaSemana = fecha.toLocaleDateString(locale, { weekday: 'long' });
    const dia = fecha.getDate().toString().padStart(2, '0');
    const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
    return `${diaSemana} ${dia}/${mes}`.toUpperCase();
}

// --- LÓGICA DE AGRUPACIÓN (Se mantiene igual) ---
const obrasPorDia = {};
obras.forEach(obra => {
    obra.data.pases.forEach(pase => {
        const fechaKey = pase.fecha;
        const horaKey = pase.hora;

        if (!obrasPorDia[fechaKey]) {
            obrasPorDia[fechaKey] = [];
        }

        obrasPorDia[fechaKey].push({
            originalData: obra.data, 
            id: obra.id,      
            horaEspecifica: horaKey
        });
    });
});

const fechasOrdenadas = Object.keys(obrasPorDia).sort();

fechasOrdenadas.forEach(fecha => {
    obrasPorDia[fecha].sort((a, b) => {
        const horaA = parseInt(a.horaEspecifica.replace(':', ''));
        const horaB = parseInt(b.horaEspecifica.replace(':', ''));
        return horaA - horaB;
    });
});
---

<div class="programacion-container">
    
   <div class="header-prog">
    <h2 class="anim-left">{t.titulo_seccion}</h2>
</div>

    {fechasOrdenadas.map((fecha) => (
        <div class="bloque-dia">
            <div class="separador-fecha">
                <h2 class="anim-left">{formatearFecha(fecha)}</h2>
                <div class="linea"></div>
            </div>

            <div class="fila-obras">
                {obrasPorDia[fecha].map((item) => {
                    const data = item.originalData;
                    
                    const tipoShow = (data.categoria === 'Otro' && data.categoria_manual) 
                        ? data.categoria_manual 
                        : data.categoria;

                    return (
                        /* CAMBIO CLAVE: Usamos baseRoute para que el enlace sea /en/obras/ o /obras/ */
                        <a href={`${baseRoute}${item.id}`} class="card-link">
                            <article class="card-obra">
                                <div class="card-img-container">
                                    <img src={data.fotos[0]} alt={data.titulo} class="card-img"/>
                                </div>
                                
                                <div class="card-content">
                                    {tipoShow && <span class="etiqueta-tipo">{tipoShow}</span>}

                                    <div style="margin-top: auto; margin-bottom: auto; text-align: center; width: 100%;">
                                        <h2 class="card-titulo">{data.titulo}</h2>
                                        <p class="card-compania">{data.compania}</p>
                                    </div>

                                    <span class="card-fecha">
                                        {item.horaEspecifica}
                                    </span>
                                </div>
                            </article>
                        </a>
                    );
                })}
            </div>
        </div>
    ))}
</div>